#include <catch2/catch.hpp>
#include <disiple/iir.hpp>
#include <type_traits>

using namespace Eigen;
using namespace disiple;

static const size_t nchan = 4;
static const size_t ndata = 50;
static const size_t ndyn_design = 9;
static const size_t nstat_design = 3;

namespace {
    template <typename Scalar> Scalar threshold();
    template <> float  threshold<float>()  { return 1e-4f; }
    template <> double threshold<double>() { return 1e-10; }
}

template <typename Scalar>
struct TestFixtureIIR
{
    Array<Scalar, Dynamic, Dynamic> raw_data, mlp_data, mhp_data, mbp_data, mbs_data,
                                    mc1_data, mc2_data, mno50_data, mno100_data, mco_data;

    iir_design dlp, dhp, dbp, dbs, dc1, dc2, dno50, dno100, dco;

    iir_design*                      dyn_designs[ndyn_design];
    Array<Scalar, Dynamic, Dynamic>* dyn_data[ndyn_design];

    iir_design*                      stat_designs[nstat_design];
    Array<Scalar, Dynamic, Dynamic>* stat_data[nstat_design];

    TestFixtureIIR()
    : raw_data(nchan, ndata)
    , mlp_data(nchan, ndata)
    , mhp_data(nchan, ndata)
    , mbp_data(nchan, ndata)
    , mbs_data(nchan, ndata)
    , mc1_data(nchan, ndata)
    , mc2_data(nchan, ndata)
    , mno50_data(nchan, ndata)
    , mno100_data(nchan, ndata)
    , mco_data(nchan, ndata)
    , dlp(butterworth(3), lowpass(.1))
    , dhp(butterworth(3), highpass(.2))
    , dbp(butterworth(3), bandpass(.15, .25))
    , dbs(butterworth(2), bandstop(.4, .5))
    , dc1(chebyshev1(4, 5.),  bandpass(.1, .4))
    , dc2(chebyshev2(3, 10.), bandstop(.1, .4))
    , dno50(notch(50.0/125,(50.0/125)/35))
    , dno100(notch(100.0/125,(100.0/125)/35))
    , dco(comb(250.0/50.0,(50.0/125)/35))

     {
        dyn_designs[0] = &dlp;    dyn_data[0] = &mlp_data;
        dyn_designs[1] = &dhp;    dyn_data[1] = &mhp_data;
        dyn_designs[2] = &dbp;    dyn_data[2] = &mbp_data;
        dyn_designs[3] = &dbs;    dyn_data[3] = &mbs_data;
        dyn_designs[4] = &dc1;    dyn_data[4] = &mc1_data;
        dyn_designs[5] = &dc2;    dyn_data[5] = &mc2_data;
        dyn_designs[6] = &dno50;  dyn_data[6] = &mno50_data;
        dyn_designs[7] = &dno100; dyn_data[7] = &mno100_data;
        dyn_designs[8] = &dco;    dyn_data[8] = &mco_data;

        stat_designs[0] = &dlp;    stat_data[0] = &mlp_data;
        stat_designs[1] = &dhp;    stat_data[1] = &mhp_data;
        stat_designs[2] = &dbs;    stat_data[2] = &mbs_data;

        // fill data with sawtooth signal
        for (size_t t=0; t<ndata; ++t)
            for (size_t c=0; c<nchan; ++c)
                raw_data(c,t) = (t + c) % 16;

        // data filtered with matlab:
        // generated by:
        //     x = [ mod(0:49,16); mod(1:50,16); mod(2:51,16); mod(3:52,16) ];
        //     [b, a] = butter(... see below ...);
        //     y = filter(b, a, x'); for i=1:4, fprintf('%35.30f, ', y(:,i)); fprintf('\n'); end;


        // [b,a] = butter(3, .1, 'low');
        mlp_data <<
        0.000000000000000000000000000000,    0.002898194633721429269712643872,    0.021371561814771840998039564852,    0.079924799927266296228900444021,    0.208021654106287146035469959315,    0.432180481119008252921531720858,    0.771550675087261272899752384546,    1.236108303021777876651299266086,    1.826701265510935368041600668221,    2.536284098372727058290365675930,    3.351802319847687616771736429655,    4.256307706687607605999801307917,    5.231001591603803291263830033131,    6.257007339812131085921009798767,    7.316761615070394242366091930307,    8.394984827636740476464183302596,    9.432872799621229376043629599735,   10.264582471737634605801758880261,   10.694453217571592062995478045195,   10.639392392685195432022737804800,   10.145017004476720501315867295489,    9.329464101037084233780660724733,    8.340979246052111051312749623321,    7.327854755595361702091850020224,    6.418990032448972371525997004937,    5.713173663424870873939198645530,    5.275149008404232731095362396445,    5.136608814974447767554011079483,    5.300444673886680391206027707085,    5.746823260371957786674101953395,    6.439942405682909765118893119507,    7.334608450976891624861764285015,    8.335678547864237231124207028188,    9.239048635714365076410103938542,    9.812416526533578320368178538047,    9.940183205495902285520060104318,    9.641129345099386682704789564013,    9.012900269424845234311760577839,    8.189573243776823829875866067596,    7.311060572626755238445639406564,    6.502799262463208052054142171983,    5.863987263568946950442750676302,    5.462561199647510079557832796127,    5.335162865625912687050913518760,    5.490490230091632284370462002698,    5.914645443859968487743117293576,    6.577348417760241261476039653644,    7.438153220205713900270438898588,    8.405692621950690224252866755705,    9.278604347956660447493959509302,
        0.002898194633721429269712643872,    0.021371561814771840998039564852,    0.079924799927266296228900444021,    0.208021654106287146035469959315,    0.432180481119008252921531720858,    0.771550675087261272899752384546,    1.236108303021777876651299266086,    1.826701265510935368041600668221,    2.536284098372727058290365675930,    3.351802319847687616771736429655,    4.256307706687607605999801307917,    5.231001591603803291263830033131,    6.257007339812131085921009798767,    7.316761615070394242366091930307,    8.394984827636740476464183302596,    9.432872799621229376043629599735,   10.264582471737634605801758880261,   10.694453217571592062995478045195,   10.639392392685195432022737804800,   10.145017004476720501315867295489,    9.329464101037084233780660724733,    8.340979246052111051312749623321,    7.327854755595361702091850020224,    6.418990032448972371525997004937,    5.713173663424870873939198645530,    5.275149008404232731095362396445,    5.136608814974447767554011079483,    5.300444673886680391206027707085,    5.746823260371957786674101953395,    6.439942405682909765118893119507,    7.334608450976891624861764285015,    8.335678547864237231124207028188,    9.239048635714365076410103938542,    9.812416526533578320368178538047,    9.940183205495902285520060104318,    9.641129345099386682704789564013,    9.012900269424845234311760577839,    8.189573243776823829875866067596,    7.311060572626755238445639406564,    6.502799262463208052054142171983,    5.863987263568946950442750676302,    5.462561199647510079557832796127,    5.335162865625912687050913518760,    5.490490230091632284370462002698,    5.914645443859968487743117293576,    6.577348417760241261476039653644,    7.438153220205713900270438898588,    8.405692621950690224252866755705,    9.278604347956660447493959509302,    9.826337105521036008326518640388,
        0.005796389267442858539425287745,    0.039844928995822252726366485831,    0.138478038039760747990314371236,    0.336118508285308037475402898053,    0.656339308131729470829895944917,    1.110920869055514348389124279493,    1.700665930956294369380543685111,    2.417294228000093525565716845449,    3.245866931234520524895970083890,    4.167320541322650839788366283756,    5.160813093527531592030754836742,    6.205695476520001641063117858721,    7.283013088020458880578189564403,    8.376515890328652957919075561222,    9.426836926063533184105835971422,   10.267929124987977829164265131112,   10.704216969708175710707109828945,   10.652904041244205757266172440723,   10.160037859523985304122106754221,    9.344251310318904657492566911969,    8.354294125425711925458926998544,    7.338927981653065479861197673017,    6.427457692050683846218817052431,    5.718997017453994580193921137834,    5.278528866372091954417555825785,    5.137903030002533455444790888578,    5.300094778090935321301913063508,    5.745293912674065417434121627593,    6.437675282726896597296217805706,    7.331990571000226886155815009261,    8.333023811060055408006519428454,    9.236590580313773557463719043881,    9.810309892177601298612898972351,    9.938511799003673985453133354895,    9.639917843936391506076688528992,    9.012127900222060006285573763307,    8.189187668524271046521789685357,    7.310990745418876279870801226934,    6.502966439227343187212682096288,    5.864313723470815808980205474654,    5.462976549609592780143429990858,    5.335608039163641791446934803389,    5.490919457716119111978514411021,    5.915026570302424957503717450891,    6.577661981167381100021884776652,    7.438390702426420197923562227516,    8.405854239897653457092019380070,    9.278696695971552443893415329512,    9.826370888395629776823625434190,    9.934155730003976003672505612485,
        0.008694583901164287809137931617,    0.058318296176872667924140358764,    0.197031276152255213629516106266,    0.464215362464328873404184605533,    0.880498135144450411182504012686,    1.450291063023767090811588786892,    2.165223558890810195975973329041,    3.007887190489249018554573922302,    3.955449764096309550609475991223,    4.982838762797610066002107487293,    6.065318480367452913526449265191,    7.180389361436199990862405684311,    8.309018836228794668841146631166,    9.389899051447386568725050892681,   10.255857377872629854209662880749,   10.710910276208917224494143738411,   10.672431545517437001535654417239,   10.187061156642084114309909637086,    9.374293020413523080947015841957,    8.383868543989441590724709385540,    7.365557740400352493281843635486,    6.449604144166180219599482370540,    5.735932336657509900135210045846,    5.290175574430433513839489023667,    5.144662745938349601715344761033,    5.302683208147206173066479095723,    5.744594121082667648181541153463,    6.434616587331188242160351364873,    7.327456325088255617572485789424,    8.327788051106756128660890681203,    9.231281106705408134871504444163,    9.805393781376382733583341178019,    9.934298530291648887668998213485,    9.636575030951835429959828616120,    9.009704897895952413477971276734,    8.187642930118578021847497439012,    7.310219594913658802681766246678,    6.502826784811498228577875124756,    5.864648076999031012235263915500,    5.463629469413305628222587984055,    5.336438739087812521688647393603,    5.491809804791607518836826784536,    5.915885025551444797997646674048,    6.578424234052347330248267098796,    7.439017829240753165720434481045,    8.406329204339110461319251044188,    9.279019931865503778567472181749,    9.826555584425411993265697674360,    9.934223295753138671670967596583,    9.620968425328420892128633568063;


        // [b,a] = butter(3, .2, 'high');
        mhp_data <<
        0.000000000000000000000000000000,    0.527624382501943323120485729305,    0.401016627791680457804091020080,    0.081682732678926228686577815097,   -0.183883644223657327643195458222,   -0.308758218560661212848117429530,   -0.303199977894920369436704277177,   -0.219547313847143765741520837764,   -0.113612541007865885944738693070,   -0.024569552938014993515025707893,    0.030100759083764749846068298211,    0.050450661444307876024595316267,    0.046357484064324161465719953412,    0.030283180524298458635712449905,    0.012492017213856065893651248189,   -0.000945138528245514919490233297,   -8.450009787732762234213623742107,    2.016200651617160666262407175964,    5.101804302911785882201911590528,    4.244830047137422290859376516892,    1.996813310874354208124259457691,   -0.088098522633791809255399130052,   -1.336757007132881369670940330252,   -1.693303422823775328254214400658,   -1.423540751526218173239612951875,   -0.874192674918263357142222957918,   -0.325558766409405286879064078676,    0.065249937371429034271841373993,    0.256865950462020542488517094171,    0.284386275409253208579229976749,    0.214830145077785417129234701861,    0.113135568528046626113336969865,   -8.417911488043726464525207120460,    1.994011826820444532870624243515,    5.056503451576700669534147891682,    4.200270913484788870562169904588,    1.965803618507377947821623820346,   -0.102564531927293423052560683573,   -1.337926742205433505716882791603,   -1.686873013123947551150649815099,   -1.414861706763716142631892580539,   -0.866848937398885688310201658169,   -0.321111825196050304498385230545,    0.066803176988318391238408366917,    0.256381459489764651493715064134,    0.282932750437796975973014923511,    0.213276875040435243136016651988,    0.111986395585926601370374555700,   -8.418500894922150479260380961932,    1.993901892821356547358391253510,
        0.527624382501943323120485729305,    0.401016627791680457804091020080,    0.081682732678926228686577815097,   -0.183883644223657327643195458222,   -0.308758218560661212848117429530,   -0.303199977894920369436704277177,   -0.219547313847143765741520837764,   -0.113612541007865885944738693070,   -0.024569552938014993515025707893,    0.030100759083764749846068298211,    0.050450661444307876024595316267,    0.046357484064324161465719953412,    0.030283180524298458635712449905,    0.012492017213856065893651248189,   -0.000945138528245514919490233297,   -8.450009787732762234213623742107,    2.016200651617160666262407175964,    5.101804302911785882201911590528,    4.244830047137422290859376516892,    1.996813310874354208124259457691,   -0.088098522633791809255399130052,   -1.336757007132881369670940330252,   -1.693303422823775328254214400658,   -1.423540751526218173239612951875,   -0.874192674918263357142222957918,   -0.325558766409405286879064078676,    0.065249937371429034271841373993,    0.256865950462020542488517094171,    0.284386275409253208579229976749,    0.214830145077785417129234701861,    0.113135568528046626113336969865,   -8.417911488043726464525207120460,    1.994011826820444532870624243515,    5.056503451576700669534147891682,    4.200270913484788870562169904588,    1.965803618507377947821623820346,   -0.102564531927293423052560683573,   -1.337926742205433505716882791603,   -1.686873013123947551150649815099,   -1.414861706763716142631892580539,   -0.866848937398885688310201658169,   -0.321111825196050304498385230545,    0.066803176988318391238408366917,    0.256381459489764651493715064134,    0.282932750437796975973014923511,    0.213276875040435243136016651988,    0.111986395585926601370374555700,   -8.418500894922150479260380961932,    1.993901892821356547358391253510,    5.056687629625685964640524616698,
        1.055248765003886646240971458610,    0.274408873081417592487696310855,   -0.237651162433828222475540314917,   -0.449450021126240883972968731541,   -0.433632792897665098053039400838,   -0.297641737229179526025291124824,   -0.135894649799366717957127548289,   -0.007677768168584897523487597937,    0.064473435131837675271526677534,    0.084771071105541828671903203940,    0.070800563804844784954184433445,    0.042264306684336006014746089932,    0.014208876984268314913606445771,   -0.005299146096594320454187254654,   -8.456372414301442930195662484039,    2.010629878489111455053262034198,    5.098315142011649037101506110048,    4.243509416403809630935484165093,    1.997067241676519167015158018330,   -0.087059624383347244958031296846,   -1.335596090210602326919797633309,   -1.692418458183422735885415022494,   -1.423067541539774438774657028262,   -0.874083819770351766464955289848,   -0.325680860499677926611639122711,    0.065037863368057280410994280828,    0.256667383864535025850273086689,    0.284253701318597506997321033850,    0.214772722936304560903408855665,    0.113136110740998496737574896542,   -8.417879473002702894746107631363,    1.994051566457467394855029851897,    5.056535675393548423528500279645,    4.200289523102784805530518497108,    1.965809304878798791094141051872,   -0.102567576715323127700685290620,   -1.337933652941472928432631306350,   -1.686879993497586660566867067246,   -1.414866664484073943697239883477,   -0.866851327756093859022712422302,   -0.321112108832958043080907373223,    0.066804126769604899038768053288,    0.256382801994265108191939361859,    0.282933910944002775522676529363,    0.213277593636540530042111640796,    0.111986660886887356980423646746,   -8.418500955313579225958164897747,    1.993901672519966972174643160542,    5.056687387092189567283639917150,    4.200561041254648131371141062118,
        1.582873147505829969361457187915,    0.147801118371154505126696676598,   -0.556985057546583561816078145057,   -0.715016398028824440302742004860,   -0.558507367234668095079541672021,   -0.292083496563438238524668122409,   -0.052241985751587449726685008500,    0.098257004670697867254602897447,    0.153516423201690344058079062961,    0.139441383127318907497738109669,    0.091150466165383470240612950874,    0.038171129304349626920611626701,   -0.001865426555764493343758658739,   -8.465080429438135212194538326003,    1.997904625351755392159702751087,    5.087173595755554167396894627018,    4.236531094603537717091512604384,    1.994425980209292958988953614607,   -0.086551762779020435800703126006,   -1.333518293709716751038740767399,   -1.690096624338868203096808429109,   -1.421297612259074583107576472685,   -0.873137399797472291140820743749,   -0.325463150203860074327621987322,    0.064793675187510224589004792506,    0.256243235857794182663838000735,    0.283856568123631802791351219639,    0.214507574754999374988528870745,    0.113021266458040336999602004653,   -8.417878388576799153497631778009,    1.994115596539514534413228830090,    5.056615154667600364746249397285,    4.200353970736491859838679374661,    1.965846524114803983707133738790,   -0.102556203972469894836194725940,   -1.337939742517526120479942619568,   -1.686893814969668170533623197116,   -1.414880625231362820670710789273,   -0.866861243196822783829702530056,   -0.321116889547392148074322903994,    0.066803559495767217413231264800,    0.256384701556813254796907131094,    0.282936595952981484458632621681,    0.213279914648934365573040849995,    0.111988098079083719937898422359,   -8.418500424711668372879103117157,    1.993901551737102373351717687910,    5.056686946489410416916143731214,    4.200560556187663330263148964150,    1.966065683818317921804919023998;


        // [b,a] = butter(3, [.15 .25], 'bandpass');
        mbp_data <<
        0.000000000000000000000000000000,    0.002898194633721795296366074979,    0.018554036354297250704936672605,    0.055975191119799497241338315234,    0.105809793367346249848282013772,    0.136027209027691609044552478736,    0.109808246532284020657854739511,    0.012511147207631474753686262602,   -0.131543511428964421394738337767,   -0.264872580721500994194173017604,   -0.323353824198231110109702513000,   -0.269102842361230054635257147311,   -0.111694717496261308742333540067,    0.093669990270442746171930537002,    0.270010450884832775564348139596,    0.352215825303233864840279920827,    0.267760826910869331740627785621,   -0.073461715639992902771027161180,   -0.601538304892773934007266234403,   -0.957147000670296232982536821510,   -0.728908043868400024045683949225,    0.175608560777316846657214455263,    1.384592909853150199950277965399,    2.237683318278652855326527060242,    2.165173491128080218715012961184,    1.034050467811815199326019865111,   -0.744453646698487125910048689548,   -2.404239829586105159364706196357,   -3.201196690634691144339285528986,   -2.773390440799018641371276316931,   -1.302365695711818593949260502995,    0.591877096166394500720286941942,    2.105125265751630170285579879419,    2.567307500459773628165294212522,    1.846398643398249328484439502063,    0.511872326189017012865178912762,   -0.549599969737346927267651608418,   -0.740458199007829387383594621497,   -0.103063462914190245856005390124,    0.764544869264082938009607914864,    1.127575847960626154176111413108,    0.585687326154964882363174183411,   -0.683905564594023185343019122229,   -2.033054576916073941106333222706,   -2.713456887909346804121923923958,   -2.289057692693488910151700110873,   -0.865531625064198228969303272606,    0.970426607197151347428132339701,    2.402515638596707248098027775995,    2.732837942388010255001518089557,
        0.002898194633721795296366074979,    0.018554036354297250704936672605,    0.055975191119799497241338315234,    0.105809793367346249848282013772,    0.136027209027691609044552478736,    0.109808246532284020657854739511,    0.012511147207631474753686262602,   -0.131543511428964421394738337767,   -0.264872580721500994194173017604,   -0.323353824198231110109702513000,   -0.269102842361230054635257147311,   -0.111694717496261308742333540067,    0.093669990270442746171930537002,    0.270010450884832775564348139596,    0.352215825303233864840279920827,    0.267760826910869331740627785621,   -0.073461715639992902771027161180,   -0.601538304892773934007266234403,   -0.957147000670296232982536821510,   -0.728908043868400024045683949225,    0.175608560777316846657214455263,    1.384592909853150199950277965399,    2.237683318278652855326527060242,    2.165173491128080218715012961184,    1.034050467811815199326019865111,   -0.744453646698487125910048689548,   -2.404239829586105159364706196357,   -3.201196690634691144339285528986,   -2.773390440799018641371276316931,   -1.302365695711818593949260502995,    0.591877096166394500720286941942,    2.105125265751630170285579879419,    2.567307500459773628165294212522,    1.846398643398249328484439502063,    0.511872326189017012865178912762,   -0.549599969737346927267651608418,   -0.740458199007829387383594621497,   -0.103063462914190245856005390124,    0.764544869264082938009607914864,    1.127575847960626154176111413108,    0.585687326154964882363174183411,   -0.683905564594023185343019122229,   -2.033054576916073941106333222706,   -2.713456887909346804121923923958,   -2.289057692693488910151700110873,   -0.865531625064198228969303272606,    0.970426607197151347428132339701,    2.402515638596707248098027775995,    2.732837942388010255001518089557,    1.822597088725564029587644654384,
        0.005796389267443590592732149958,    0.034209878074872704378783794255,    0.093396345885301740308293005910,    0.155644395614893016333013520125,    0.166244624688037107018701021843,    0.083589284036876820849215619091,   -0.084785952117020571550121132987,   -0.275598170065559922026210415424,   -0.398201650014037400460154003667,   -0.381835067674961337047534470912,   -0.214851860524230275917290100551,    0.045713407368702982380703758736,    0.299034698037137725012968303417,    0.446350911499210301069950901365,    0.388050085582075432455440022750,    0.025554589268392748080405141309,   -0.558806913520012993323859973316,   -0.979985045139409871595148615597,   -0.800265551339843450584510264889,    0.088437978030365294035419765351,    1.314393304198943512872688188509,    2.204448018652171104037051918567,    2.171043348208085976835945984931,    1.066707880429485388873445117497,   -0.703222947471328629909237406537,   -2.369756444636640146939043916063,   -3.180817050454029626394003571477,   -2.766460270818455136065949773183,   -1.303810766264463572028375892842,    0.587125808979138574805745065532,    2.099381513699873469391832259134,    2.560063579516527632051747787045,    1.836256106368402862827338140050,    0.498808227305227003256504758610,   -0.563173050320583956640518863423,   -0.750429567082863124838354451640,   -0.105619393058438620913719319105,    0.770884540207021573543499926018,    1.141023711549514763063939426502,    0.601823628861318571381389119779,   -0.670308616060740880548962650209,   -2.025957055072236112636119287345,   -2.714186150420815124562068376690,   -2.296169766569932768618400587002,   -0.875784538932853129367117617221,    0.960581764337301691192294583743,    2.395643762851096703059283754556,    2.729916956791657689507246686844,    1.823181627717526120946445189475,    0.277530968840259628649391743238,
        0.008694583901165385889098224936,    0.049865719795448161522077867858,    0.130817500650803969497459888771,    0.205478997862439699551018179591,    0.196462040348382105392488483631,    0.057370321541467969583827368751,   -0.182083051441676663229074506489,   -0.419652828702163027685401175404,   -0.531530719306584797934078778781,   -0.440316311151703054793671299194,   -0.160600878687236270359051104606,    0.203121532233675794465455055615,    0.504399405803861111685648666025,    0.576320257974084482199828016746,    0.266133106610855374452029309396,   -0.360774303703223109263120704782,   -0.894522262393921518963679773151,   -0.845941640278160433830123565713,   -0.054277036912651233091509084261,    1.140052138704903184063255139336,    2.064048807343652924828347750008,    2.104572748955086058941787996446,    1.078447594589546643106814372004,   -0.637908122235867458549307684734,   -2.287295046182181934568689030129,   -3.111850280555008119165449897991,   -2.725700990457151640100619260920,   -1.289950426303492880819590027386,    0.584235667873589270548961849272,    2.089878939325105378088665020186,    2.548576075412904984318629431073,    1.821768264482056531861076109635,    0.478523153245944410372203492443,   -0.589301248087600426650567442266,   -0.777575728248812270138046187640,   -0.125562129208199230179232586124,    0.765772679918529708409380418743,    1.153703053435138903282108913118,    0.628719356038724530577610494220,   -0.638036010648362572617031673872,   -1.998763158005853357579439943947,   -2.699991106733161672082133009098,   -2.297628291592791249797755881445,   -0.890008686685644923031190955953,    0.940075936600040296120539551339,    2.375954077131370745235017238883,    2.716173205300347781587788631441,    1.817339656524716184904377769271,    0.278700046824118974342354704277,   -0.950426810215363127021248601523;

        // [b,a] = butter(2, [.4 .5], 'stop');
        mbs_data <<
        0.000000000000000000000000000000,    0.800592403464569390969529649738,    1.545521293255003314470741315745,    2.626520109175894290842734335456,    3.841811315846000773888135881862,    4.843296185922341123841761145741,    5.690837325446652883442766324151,    6.647430530905042544986827124376,    7.735778696856279168514447519556,    8.787233767262659256402912433259,    9.749473789030005832501046825200,   10.711352063142062007727872696705,   11.718341624873218620450643356889,   12.734847032575499881090763665270,   13.739731266956656696720528998412,   14.742992381367564291849703295156,    2.930287769976271938787704129936,    4.805345866182004321842669014586,    0.423083668235489485098810291674,   -0.706503737457064406868312289589,    3.728668871204006141084619230242,    7.176144522084566546027417643927,    6.410972516016681943540334032150,    5.311250150143910886413323169108,    6.923446522959700644150871085003,    9.350386012161390425490026245825,   10.336742831621151594845287036151,   10.609332757470806285482467501424,   11.471521711273544141818092612084,   12.666415826335567729188369412441,   13.683658117371951590257594943978,   14.777948495527898131740585085936,    3.169515948127011206736369786086,    4.901530690953146418564756459091,    0.136382195049621790516880537325,   -0.940749806945073263619860881590,    3.957022082381276284479554306017,    7.498599162009579544019288732670,    6.296403940273937571703299909132,    4.970455558591620359720764099620,    6.918061590933386462154430773808,    9.648303983107892278781037020963,   10.433594514698320665502251358703,   10.391113697062284160210765548982,   11.327112592703379334579949500039,   12.795693814516734931885366677307,   13.833196206720447918314675916918,   14.725011919042582775318805943243,    3.045058593481345887710176612018,    4.902662543451126175853005406680,
        0.800592403464569390969529649738,    1.545521293255003314470741315745,    2.626520109175894290842734335456,    3.841811315846000773888135881862,    4.843296185922341123841761145741,    5.690837325446652883442766324151,    6.647430530905042544986827124376,    7.735778696856279168514447519556,    8.787233767262659256402912433259,    9.749473789030005832501046825200,   10.711352063142062007727872696705,   11.718341624873218620450643356889,   12.734847032575499881090763665270,   13.739731266956656696720528998412,   14.742992381367564291849703295156,    2.930287769976271938787704129936,    4.805345866182004321842669014586,    0.423083668235489485098810291674,   -0.706503737457064406868312289589,    3.728668871204006141084619230242,    7.176144522084566546027417643927,    6.410972516016681943540334032150,    5.311250150143910886413323169108,    6.923446522959700644150871085003,    9.350386012161390425490026245825,   10.336742831621151594845287036151,   10.609332757470806285482467501424,   11.471521711273544141818092612084,   12.666415826335567729188369412441,   13.683658117371951590257594943978,   14.777948495527898131740585085936,    3.169515948127011206736369786086,    4.901530690953146418564756459091,    0.136382195049621790516880537325,   -0.940749806945073263619860881590,    3.957022082381276284479554306017,    7.498599162009579544019288732670,    6.296403940273937571703299909132,    4.970455558591620359720764099620,    6.918061590933386462154430773808,    9.648303983107892278781037020963,   10.433594514698320665502251358703,   10.391113697062284160210765548982,   11.327112592703379334579949500039,   12.795693814516734931885366677307,   13.833196206720447918314675916918,   14.725011919042582775318805943243,    3.045058593481345887710176612018,    4.902662543451126175853005406680,    0.221549661203724435054596142436,
        1.601184806929138781939059299475,    2.290450183045437348994255444268,    3.707518925096785267214727355167,    5.057102522516107256933537428267,    5.844781055998680585616966709495,    6.538378464970966419400610902812,    7.604023736363435759244566725101,    8.824126862807510462971549713984,    9.838688837669035791577698546462,   10.711713810797359514026538818143,   11.673230337254125288382056169212,   12.725331186604364575032377615571,   13.751352440277777589017205173150,   14.744615501337817065063973132055,    2.936775040345366072358501696726,    4.817677832804263537980205001077,    0.412668925514252160624550924695,   -0.730737963611171714717329450650,    3.733488494338095264879484602716,    7.206039783197244474877152242698,    6.415687429187455492751723795664,    5.282554197008588303674514463637,    6.909896680874248353632083308185,    9.372794145282270505958877038211,   10.355672685623318329817266203463,   10.595531086690755273593822494149,   11.451449749687874657411157386377,   12.671902973752384724548392114230,   13.701341087783530880983562383335,   14.778726814789692411977739538997,    3.156275558301568473495990474476,    4.897230725449662536163941695122,    0.144698661979745457628609983658,   -0.935464146143161201507609803230,    3.952908036205396768991704448126,    7.494106707969583780482025758829,    6.297669636962748285213820054196,    4.973300182395811397384477459127,    6.918203676813570623949090077076,    9.647166406882629274832652299665,   10.433189163027327239774422196206,   10.390991829008651592403111862950,   11.327105689833269153155015374068,   12.796436964936784619339960045181,   13.833831764319629797910238266923,   14.724225659909709662542809383012,    3.043911105133703109970610967139,    4.903115511581386698480855557136,    0.222926823570044563282976923801,   -0.916656377977646652510657077073,
        2.401777210393708283930891411728,    3.035379072835871383517769572791,    4.788517741017676243586720374878,    6.272393729186214628157358674798,    6.846265926075020047392172273248,    7.385919604495276402644776680972,    8.560616941821823644431788125075,    9.912475028758743533785491308663,   10.890143908075419432179842260666,   11.673953832564711419195191410836,   12.635108611366177910895203240216,   13.732320748335519411398308875505,   14.767857847980071284155201283284,    2.940021280285859184289165568771,    4.830652373542426047947628831025,    0.437332858758774589702511548239,   -0.751567449053615277421158680227,    3.685020042029888642787227581721,    7.215679029465394300757452583639,    6.475477951412792698704379290575,    5.291984023350154942022527393419,    6.852504774603629833507056900999,    9.345694461111362372207622684073,   10.400488951865051845402376784477,   10.633390794695078085396744427271,   11.423846408127790397202261374332,   12.631759050581059966589236864820,   13.712315382617152437205731985159,   14.814092755612840335288638016209,    3.157832196825164139397656981600,    4.870749945798777957861602772027,    0.136098730972773251934881955094,   -0.918831212282908982302842559875,    3.963479357809229775000403606100,    7.485878615617819420435807842296,    6.288684728882745211819838004885,    4.975831575773433712583937449381,    6.923892924421959804703874397092,    9.647450578642995822065131505951,   10.430914010576795902807134552859,   10.390181125666668293661132338457,   11.326861953726005793896547402255,   12.796423159196557151062734192237,   13.835318065159725620105746202171,   14.725496775108073421733934083022,    3.042338586867956884418617846677,    4.900820534886102919358563667629,    0.223832759830566496717096924840,   -0.913902053245005951964685664279,    3.909872902160230978552135638893;

        // [b,a] = cheby1(4, 5, [.1 .4],'bandpass');
        mc1_data <<
        0.000000000000000000000000000000,    0.003715151251024022185237560834,    0.027464305504586786904619444272,    0.092004987744669919358386778185,    0.180363681590322566528072911751,    0.211850891337735075525827710408,    0.098681490420522405271341881416,   -0.150719903341871075408420210806,   -0.402538612323838584927671035985,   -0.497250907600641833816723647033,   -0.385313086374254376575976266395,   -0.158634445897630316224535818037,    0.048208665457844371293738561235,    0.173614408137404668819314679240,    0.245176785446363454390450442588,    0.304884294728760718573568055945,    0.287788670503646981657652759168,   -0.044055184036192282515109752694,   -0.773797405917188374502302394831,   -1.269971698774094992501204615110,   -0.481106400477511353397375160057,    1.712920361404374425262631120859,    3.771227248683964639042187627638,    3.711957144612657355509099943447,    1.169153000612171089400703749561,   -2.076946753743725615493076475104,   -3.797432760947796026584910578094,   -3.371802904321892668804139248095,   -2.001942985991485013386181890382,   -1.100227564286332837539816864592,   -0.866511877725126500315866451274,   -0.537875939462655661138512641628,    0.292459722511399622391081720707,    1.016443157875875469287052510481,    0.935972602432357247970173830254,    0.614502182555301090793875573581,    1.490761494174740464657702432305,    3.797822559813883280810387077508,    5.570569100282530605738884332823,    4.473545268289359277957828453509,    0.508459389720017918001815360185,   -3.684809689823855372026173427003,   -5.414116980792508471154178550933,   -4.456683693425578240976392407902,   -2.757153722162251963112566954806,   -1.971602174294163178913663614367,   -1.878937483590307211400727283035,   -1.260144903447041109245674306294,    0.199584226988477553277334664017,    1.407561075877936884737096079334,
        0.003715151251024022185237560834,    0.027464305504586786904619444272,    0.092004987744669919358386778185,    0.180363681590322566528072911751,    0.211850891337735075525827710408,    0.098681490420522405271341881416,   -0.150719903341871075408420210806,   -0.402538612323838584927671035985,   -0.497250907600641833816723647033,   -0.385313086374254376575976266395,   -0.158634445897630316224535818037,    0.048208665457844371293738561235,    0.173614408137404668819314679240,    0.245176785446363454390450442588,    0.304884294728760718573568055945,    0.287788670503646981657652759168,   -0.044055184036192282515109752694,   -0.773797405917188374502302394831,   -1.269971698774094992501204615110,   -0.481106400477511353397375160057,    1.712920361404374425262631120859,    3.771227248683964639042187627638,    3.711957144612657355509099943447,    1.169153000612171089400703749561,   -2.076946753743725615493076475104,   -3.797432760947796026584910578094,   -3.371802904321892668804139248095,   -2.001942985991485013386181890382,   -1.100227564286332837539816864592,   -0.866511877725126500315866451274,   -0.537875939462655661138512641628,    0.292459722511399622391081720707,    1.016443157875875469287052510481,    0.935972602432357247970173830254,    0.614502182555301090793875573581,    1.490761494174740464657702432305,    3.797822559813883280810387077508,    5.570569100282530605738884332823,    4.473545268289359277957828453509,    0.508459389720017918001815360185,   -3.684809689823855372026173427003,   -5.414116980792508471154178550933,   -4.456683693425578240976392407902,   -2.757153722162251963112566954806,   -1.971602174294163178913663614367,   -1.878937483590307211400727283035,   -1.260144903447041109245674306294,    0.199584226988477553277334664017,    1.407561075877936884737096079334,    1.401426479312962047885093852528,
        0.007430302502048044370475121667,    0.051213459758149545986150030785,    0.156545669984753027526025448424,    0.268722375435975213697759045317,    0.243338101085147612279158124693,   -0.014487910496690906830830058993,   -0.400121297104267803490529331611,   -0.654357321305815031742270093673,   -0.591963202877462624229565335554,   -0.273375265147897339446103615046,    0.068044194578939579121090730496,    0.255051776813223440854017098900,    0.299020150816816099315076371568,    0.316739162755134862070605095141,    0.305149383994595790881021457608,    0.009591418254190924377877713880,   -0.708019438319729466080332258571,   -1.231963365702839485749109371682,   -0.475114060369814683593148174623,    1.712320922881534812631798558868,    3.772153238175490308492499025306,    3.688499293954190516586777448538,    1.100307377745819215064670970605,   -2.166350388156607742473624966806,   -3.852497752052446600146140553989,   -3.364697194210023667437781114131,   -1.960543614820282609656487693428,   -1.073587120546674045229451621708,   -0.870328100086149025749193697266,   -0.544702663730550429299626102875,    0.311891799574411709983223772724,    1.055795601374375447534248451120,    0.963992041077290529038634758763,    0.614822421666927021455251178850,    1.478595235850274081101929368742,    3.795989679085687740212051721755,    5.579948297941577983749539271230,    4.476076443415329286779069661861,    0.495213588756880818131378418911,   -3.699907440684109261042067373637,   -5.412798793854301848682553099934,   -4.441504120869698368778699659742,   -2.749763812090589620851233121357,   -1.986434461401777484823583108664,   -1.906034614449111375122924982861,   -1.278038444165740195046510052634,    0.198505340434802945992487366311,    1.410985496656453674901854355994,    1.395916180076128387810285857995,    0.954828298456271817862273110222,
        0.011145453753072066122031813507,    0.074962614011712308537127569252,    0.221086352224836163449239734291,    0.357081069281627860867445178883,    0.274825310832560398832669079638,   -0.127657311413902019303634460812,   -0.649522690866656593478012382548,   -0.906176030287771272497820973513,   -0.686675498154241337189773730643,   -0.161437443921460810347667802489,    0.294722835055651222191386295890,    0.461894888168832173924727158010,    0.424425893496546857708295874545,    0.328859120047885866711112612393,    0.044312845236516421043582170114,   -0.600726233738786086213679027423,   -1.100407430508062223140086643980,   -0.399097394227746871120388050258,    1.724305603096247807570762233809,    3.770954361128970866445797582855,    3.690351272936318149930912113632,    1.053391676427979595231931853050,   -2.304041633890035356557746126782,   -4.031305020878535927408847783227,   -3.474827176419104546312155434862,   -1.946332194595880249465835731826,   -0.990788378203574793268160192383,   -0.817047212606707984328124894091,   -0.552335108453584910925826534367,    0.298238351036278714900618069805,    1.094659755496900421789518986770,    1.042696928070252493370162483188,    0.670861298953073004192049211269,    1.479235714070952445453599466418,    3.771657162435904986352852574782,    5.576282536486282914722778514260,    4.494834838736358584299068752443,    0.500275939013229753449252257269,   -3.726399042605057054799999605166,   -5.442994295569201668172354402486,   -4.438867746987956053317248006351,   -2.719404666974239770382837377838,   -1.971654641255143447509112775151,   -1.935699188663057457304716990620,   -1.332232705884785595173980254913,    0.162718258993145070689934073016,    1.408827723542828591618558675691,    1.402765021626321217951272046776,    0.943807699976656366835925382475,    1.859127632317154832364280991897;

        // [b,a] = cheby2(3, 10, [.1 .4], 'stop');
        mc2_data <<
        0.000000000000000000000000000000,    0.551712889144208795677570833504,    0.671515516180813509805602734559,    0.983915055344079192423123458866,    1.542796923033834755045745623647,    2.148744946170499048321289592423,    2.749795752772523194096265797270,    3.457852251817756350504851070582,    4.330009629307876473092164815171,    5.285598382809946649274479568703,    6.228633779850625273866171482950,    7.162004883006297006886597955599,    8.152685814058997948450269177556,    9.231654055353107679593449574895,   10.365709231145380897487484617159,   11.509896660066287310542065824848,    3.824269438738880921846430283040,   11.881576732475835456170898396522,    9.946099753567857248981454176828,    7.124610558977138019542962865671,    7.450988204541156179061545117293,    8.565361777789318509235272358637,    7.855594643255473741305650037248,    6.205050740258188923803572834004,    5.819378153759516614229596598307,    6.947450973354542647086873330409,    8.017187938932170965244949911721,    8.014902077173744032734248321503,    7.524630054039452176084523671307,    7.577369892017855157462236093124,    8.364281507872696863614692119882,    9.369982072043464782495902909432,    1.450308167115345270303805591539,    9.377703665676655475635925540701,    7.699402495307501759214119374519,    5.473612279721122853004544595024,    6.456101498246592740315463743173,    8.118018882520177115225123998243,    7.885790507309272001634781190660,    6.712796444885769986399282061029,    6.761603765980184199690938839922,    8.178409028764829002966507687233,    9.352131701752568915253505110741,    9.314838107847887016532695270143,    8.706340299694719675471787923016,    8.572074975437544708256609737873,    9.099874242536110102719248970971,    9.795692169692683748394301801454,    1.561965885179844804042659234256,    9.211526518703767152373984572478,
        0.551712889144208795677570833504,    0.671515516180813509805602734559,    0.983915055344079192423123458866,    1.542796923033834755045745623647,    2.148744946170499048321289592423,    2.749795752772523194096265797270,    3.457852251817756350504851070582,    4.330009629307876473092164815171,    5.285598382809946649274479568703,    6.228633779850625273866171482950,    7.162004883006297006886597955599,    8.152685814058997948450269177556,    9.231654055353107679593449574895,   10.365709231145380897487484617159,   11.509896660066287310542065824848,    3.824269438738880921846430283040,   11.881576732475835456170898396522,    9.946099753567857248981454176828,    7.124610558977138019542962865671,    7.450988204541156179061545117293,    8.565361777789318509235272358637,    7.855594643255473741305650037248,    6.205050740258188923803572834004,    5.819378153759516614229596598307,    6.947450973354542647086873330409,    8.017187938932170965244949911721,    8.014902077173744032734248321503,    7.524630054039452176084523671307,    7.577369892017855157462236093124,    8.364281507872696863614692119882,    9.369982072043464782495902909432,    1.450308167115345270303805591539,    9.377703665676655475635925540701,    7.699402495307501759214119374519,    5.473612279721122853004544595024,    6.456101498246592740315463743173,    8.118018882520177115225123998243,    7.885790507309272001634781190660,    6.712796444885769986399282061029,    6.761603765980184199690938839922,    8.178409028764829002966507687233,    9.352131701752568915253505110741,    9.314838107847887016532695270143,    8.706340299694719675471787923016,    8.572074975437544708256609737873,    9.099874242536110102719248970971,    9.795692169692683748394301801454,    1.561965885179844804042659234256,    9.211526518703767152373984572478,    7.307985473725532976629892800702,
        1.103425778288417591355141667009,    0.791318143217418334955937098130,    1.296314594507345319129854033235,    2.101678790723590317668367788428,    2.754692969307164673864463111386,    3.350846559374552224852550352807,    4.165908750862995724162374244770,    5.202167006798014803337082412327,    6.241187136312053240772002027370,    7.171669176891356300984625704587,    8.095375986162032688753242837265,    9.143366745111748628005443606526,   10.310622296647231621591345174238,   11.499764406937662997165716660675,    3.826677862679900954390177503228,   11.876612637440555175771805807017,    9.946769238464611362360301427543,    7.148456112262628003861664183205,    7.493780133659663889034163730685,    8.608779801809907539222876948770,    7.889288807391862334839061077219,    6.232304532694650234248001652304,    5.845218876187751710915563307935,    6.969461286834072843987542000832,    8.029298791727221384917356772348,    8.015338955997286518595501547679,    7.516976497905091036955127492547,    7.565564042796451893480025319150,    8.349384631908286280577158322558,    9.351843956841468852303478342947,    1.430316106285886235127691179514,    9.358741961128972164374317799229,    7.683801470710064585034615447512,    5.462076675869936615015376446536,    6.448498351841582376664518960752,    8.114422910329901483805770112667,    7.886443775950153778353524103295,    6.717430035941161392543108377140,    6.769227878211251159257244580658,    8.187775435697162151882366742939,    9.362205706783619518773775780573,    9.324821466901791922055053873919,    8.715468107040546641428591101430,    8.579592075544717033608321798965,    9.105224725290675280575669603422,    9.798661212708507761703913274687,    1.562629267428576440579490736127,    9.210118178811974587461008923128,    7.304836190638947179820661403937,    4.908339098816482781728609552374,
        1.655138667432626498055014963029,    0.911120770254023160106271461700,    1.608714133670609225390535357292,    2.660560658413341883488101302646,    3.360640992443824526247908579535,    3.951897365976569709289378806716,    4.873965249908223107411231467267,    6.074324384288132705478346906602,    7.196775889814116311526959179901,    8.114704573932030484684219118208,    9.028747089317715079914705711417,   10.134047676164456674996472429484,   11.389590537941328918236649769824,    3.806413356422588378791260765865,   11.881429485322486883092096832115,    9.936841048393930009297037031502,    7.149795082056079387200497876620,    7.541471240230704253804105974268,    8.694363660047068620428944996092,    7.976124855433207372357173881028,    6.299692860967626373280836560298,    5.899726461060972759753440186614,    7.021142731690976468428289081203,    8.073319418686814685770514188334,    8.039560661587945133987886947580,    7.517850255552716021156811621040,    7.550256930528251864132016635267,    8.325772933465970027100411243737,    9.322050204913063353728830406908,    1.394039875882192802691861288622,    9.318757839470233506062868400477,    7.645878061614808096635442780098,    5.430874626675133320929944602540,    6.425427144139202795258825062774,    8.099216617519720884388334525283,    7.879251831569250796860615082551,    6.718736573222409802497168129776,    6.778495060321430010219501127722,    8.203023660158677898834866937250,    9.380938520647720935130564612336,    9.344969476963431276317351148464,    8.735434825147986970250713056885,    8.597847690236026352295084507205,    9.120258925504643343629140872508,    9.809362178217240213484728883486,    1.568567353459876301258191233501,    9.211444943309201605075031693559,    7.302019510855251915870667289710,    4.902040532643314740823825559346,    5.773483799048605646930809598416;

        // [b,a] = iirnotch(50/125, (50/125)/35)
        mno50_data <<
        0.000000000000000000000000000000,    0.982362770083369696294539608061,    1.954017385605113288349343747541,    2.953823036974874582938355160877,    3.981050557747017215604046214139,    4.997768793027730360734040004900,    5.981651910400646698917626054026,    6.955738301171762394403685902944,    7.955553647097183933567521307850,    8.980441058068608484177275386173,    9.995729181520179196240860619582,   10.981001593668308302653713326436,   11.957311137358498598359801690094,   12.957135945924754594216210534796,   13.979884369582467940062997513451,   14.993864713154845702547390828840,    0.262602342579221215146390022710,    1.412274787428654754251056147041,    1.961692221500511923437670702697,    2.543735584419521522647755773505,    3.724668583869473081904288846999,    5.237732526255930665115556621458,    6.374680189350200087972098117461,    6.962859825521924506119830766693,    7.580712944969047129006867180578,    8.745992363782750800282883574255,   10.215005904989190810283616883680,   11.340310499296849755523908243049,   11.963917784493023788172649801709,   12.614512585190009730240490171127,   13.765492620353306563174555776641,   15.194237789425464768555684713647,    0.591084762032659583042004669551,    1.418402470870653964141183678294,    1.648517164350580488374475862656,    2.347684957712887765524101268966,    3.907767640957459320816269610077,    5.538033159248593406687177775893,    6.380362451340638507701896742219,    6.676602027217201751341235649306,    7.401434399471490621635894058272,    8.913306547520029710085509577766,   10.489542556191596034409485582728,   11.345578653226876753024043864571,   11.702263738528035474928401526995,   12.450571304583553100542303582188,   13.918382704383558845506740908604,   15.445220834160497958009727881290,    0.595968027899395735857979161665,    1.179237512159549083889942266978,
        0.982362770083369696294539608061,    1.954017385605113288349343747541,    2.953823036974874582938355160877,    3.981050557747017215604046214139,    4.997768793027730360734040004900,    5.981651910400646698917626054026,    6.955738301171762394403685902944,    7.955553647097183933567521307850,    8.980441058068608484177275386173,    9.995729181520179196240860619582,   10.981001593668308302653713326436,   11.957311137358498598359801690094,   12.957135945924754594216210534796,   13.979884369582467940062997513451,   14.993864713154845702547390828840,    0.262602342579221215146390022710,    1.412274787428654754251056147041,    1.961692221500511923437670702697,    2.543735584419521522647755773505,    3.724668583869473081904288846999,    5.237732526255930665115556621458,    6.374680189350200087972098117461,    6.962859825521924506119830766693,    7.580712944969047129006867180578,    8.745992363782750800282883574255,   10.215005904989190810283616883680,   11.340310499296849755523908243049,   11.963917784493023788172649801709,   12.614512585190009730240490171127,   13.765492620353306563174555776641,   15.194237789425464768555684713647,    0.591084762032659583042004669551,    1.418402470870653964141183678294,    1.648517164350580488374475862656,    2.347684957712887765524101268966,    3.907767640957459320816269610077,    5.538033159248593406687177775893,    6.380362451340638507701896742219,    6.676602027217201751341235649306,    7.401434399471490621635894058272,    8.913306547520029710085509577766,   10.489542556191596034409485582728,   11.345578653226876753024043864571,   11.702263738528035474928401526995,   12.450571304583553100542303582188,   13.918382704383558845506740908604,   15.445220834160497958009727881290,    0.595968027899395735857979161665,    1.179237512159549083889942266978,    1.498601075171122287699176922615,
        1.964725540166739392589079216123,    2.925672001126856880404147887020,    3.953628688344635211393551799119,    5.008278078519159848269737267401,    6.014487028308444394042453495786,    6.965535027773565701636471203528,    7.929824691942877201711326051736,    8.955368993022602808196097612381,   10.005328469040030370251770364121,   11.011017304971748131947606452741,   11.966274005816437409066566033289,   12.933620681048692446779568854254,   13.956960754491010590072619379498,   15.002632793240177733196105691604,    0.290040735393304771605471614748,    1.420474766323530202427605217963,    1.940200185723798931292094493983,    2.522776318702541153982110699872,    3.732677425639497670317723532207,    5.262814901981293758126412285492,    6.382182207746496693800963839749,    6.943216944346735530757541710045,    7.561549703426477364587299234699,    8.753307705469890009908340289257,   10.237934563133862297945597674698,   11.347173960667568337612465256825,   11.945964960260500475897060823627,   12.596991466242890567173162708059,   13.772174508715654184243248892017,   15.215197659176620703647131449543,    0.597364014456339020853192778304,    1.401994294214354397354327375069,    1.632497454110099610602446773555,    2.353788240752793914367657635012,    3.926927772661580995361418899847,    5.543777925598801559203820943367,    6.365366023500039105442738218699,    6.661955069456884537260066281306,    7.407009176501965441730135353282,    8.930821476100021527599892579019,   10.494798327722691055896575562656,   11.331872509683172722816379973665,   11.688871901484660043024632614106,   12.455663337334446083559669204988,   13.934393695688662262455181917176,   15.450029230603878005467777256854,    0.583441154616444634939398383722,    1.166993243865932949887564973324,    1.503252163307414068782463800744,    2.502030599732429028136948545580,
        2.947088310250109088883618824184,    3.897326616648600694503556951531,    4.953434339714396728027168137487,    6.035505599291301592757008620538,    7.031205263589156650994027586421,    7.949418145146482927998476952780,    8.903911082713992897197385900654,    9.955184338948026123716772417538,   11.030215880011457585396783542819,   12.026305428423318844011191686150,   12.951546417964564739122579339892,   13.909930224738884518842496618163,   14.956785563057266585929028224200,    0.307576895563975938330258941278,    1.475351551951701090104052127572,    1.956600143513545830842303985264,    2.479792247149108952442020381568,    3.690758894205537377075643235003,    5.278832585521350040380639256909,    6.432346959197227320714773668442,    6.958220981139324301523174653994,    7.522263941076092308435363520402,    8.714981222384750481069204397500,   10.252565246508147822623868705705,   11.393031276956918418363784439862,   11.959691883001934087360496050678,   12.561085817777829731767269549891,   13.737132270821412305394915165380,   15.228561435901328380282393482048,    0.639283753958661549177122651599,    1.414552799061709720263024792075,    1.599681100797489818887697765604,    2.321748820271829494288340356434,    3.939134338741402174832728633191,    5.582098189007052013721477123909,    6.376855556200451857762345753144,    6.631962213775675074600712832762,    7.377715260981327460854117816780,    8.941971030160978273215732770041,   10.529828184882681796352699166164,   11.342384052745359213076881133020,   11.661459614397244877181947231293,   12.428879663247689890681613178458,   13.944577761190448228489913162775,   15.482051213214088392078338074498,    0.593057947503211835282854735851,    1.141939497300031414184218192531,    1.478763626720172696948907287151,    2.511332776005006373054584400961,    4.170889300217451634011922578793;

        // [b,a] = iirnotch(100/125, (100/125)/35)
        mno100_data <<
        0.000000000000000000000000000000,    0.965326111781873885675508972781,    1.984810425706750480756568322249,    2.986646613482797807392898903345,    3.965645495787978980217758362414,    4.996738928953808667188241088297,    5.967717885494400853474417090183,    6.984109564514239920640648051631,    7.985515400403150110264505201485,    8.968064629980021962296632409561,    9.994013175542526994377112714574,   10.969723950156527791932603577152,   11.983512959488653137896108091809,   12.984580307426242029578133951873,   13.970080411976393719442057772540,   14.991734910601703489874125807546,    0.526188661054352024848412838764,    0.671256261951218458072787598212,    1.954428433833260037033596745459,    3.307777931625810019511391146807,    3.492335776905773236933328007581,    5.437154220173902707813340384746,    5.720306569800424512095560203306,    6.960675364354948158052138751373,    8.252371882501808642018659156747,    8.573062452869976368674542754889,   10.362628528940392769186473742593,   10.761582056435846865838357189205,   11.965563424824374294530571205541,   13.206323948552803670963839977048,   13.640437039138351593692277674563,   15.300248722599331330229688319378,    0.351094878959809619800580549054,    0.657621508266381105123343786545,    2.138676388554280993758993645315,    3.032684652956393112077648765990,    3.750541579202510966695172101026,    5.289870884333772060870160203194,    5.710053094121112948755580873694,    7.113760144323515888231668213848,    8.022806521785891931131118326448,    8.789158891252832006557582644746,   10.238746433132641655561201332603,   10.753966644328773583083602716215,   12.092749316876165721623692661524,   13.014755730001272837625947431661,   13.821287441443818266861853771843,   15.196056359258712120663403766230,    0.345527275828199975649113184772,    0.763284571803080735818980429030,
        0.965326111781873885675508972781,    1.984810425706750480756568322249,    2.986646613482797807392898903345,    3.965645495787978980217758362414,    4.996738928953808667188241088297,    5.967717885494400853474417090183,    6.984109564514239920640648051631,    7.985515400403150110264505201485,    8.968064629980021962296632409561,    9.994013175542526994377112714574,   10.969723950156527791932603577152,   11.983512959488653137896108091809,   12.984580307426242029578133951873,   13.970080411976393719442057772540,   14.991734910601703489874125807546,    0.526188661054352024848412838764,    0.671256261951218458072787598212,    1.954428433833260037033596745459,    3.307777931625810019511391146807,    3.492335776905773236933328007581,    5.437154220173902707813340384746,    5.720306569800424512095560203306,    6.960675364354948158052138751373,    8.252371882501808642018659156747,    8.573062452869976368674542754889,   10.362628528940392769186473742593,   10.761582056435846865838357189205,   11.965563424824374294530571205541,   13.206323948552803670963839977048,   13.640437039138351593692277674563,   15.300248722599331330229688319378,    0.351094878959809619800580549054,    0.657621508266381105123343786545,    2.138676388554280993758993645315,    3.032684652956393112077648765990,    3.750541579202510966695172101026,    5.289870884333772060870160203194,    5.710053094121112948755580873694,    7.113760144323515888231668213848,    8.022806521785891931131118326448,    8.789158891252832006557582644746,   10.238746433132641655561201332603,   10.753966644328773583083602716215,   12.092749316876165721623692661524,   13.014755730001272837625947431661,   13.821287441443818266861853771843,   15.196056359258712120663403766230,    0.345527275828199975649113184772,    0.763284571803080735818980429030,    1.978819533449810652570022284635,
        1.930652223563747771351017945562,    3.004294739631627297882232596749,    3.988482801258844467895414709346,    4.944644378093159708953407971421,    6.027832362119640130515563214431,    6.938696842034991263403753691819,    8.000501243534078099628459312953,    8.986921236292063852602041151840,    9.950613859556890261615080817137,   11.019961721105033802814432419837,   11.945434724770532142201773240231,   12.997301968820771378432255005464,   13.985647655363838026687517412938,   14.955580516526531198451266391203,    0.568171620717055958493801881559,    0.639328965728917175681544904364,    1.965225115517406084819640454953,    3.320627474867896999910499289399,    3.462217728114091563895726721967,    5.472238061959988186799819231965,    5.693537477770194144000015512574,    6.969835969189793090095008665230,    8.262976369807288890001473191660,    8.547973643885768524341983720660,   10.391946414184538127756241010502,   10.739138514344608310580042598303,   11.973333921733914309015744947828,   13.215074105099382961725495988503,   13.619538272879374574131361441687,   15.324747789530039909777769935317,    0.332278523390083790900462190621,    0.664211236045517683379557638546,    2.145895175169261648306928691454,    3.015276665454444060543437444721,    3.771013465298614697474022250390,    5.274096004161688000522190122865,    5.715640153634517162117845145985,    7.119714473201378623912205512170,    8.008306664788781503716563747730,    8.806265250139066580459257238545,   10.225521814299806777626145048998,   10.758702508359093030776421073824,   12.097659747519657003067550249398,   13.002678536421637289777208934538,   13.835581274759167769161649630405,   15.184970052685599739561439491808,    0.349540727985388599563520983793,    0.767333334496039798366950890340,    1.968760519503792938422748193261,    3.195977869277371485878802559455,
        2.895978335345621879071131843375,    4.023779053556503448874082096154,    4.990318989034892460665560065536,    5.923643260398340437689057580428,    7.058925795285471593842885340564,    7.909675798575579008797831193078,    9.016892922553923384043628175277,    9.988327072180968713155380100943,   10.933163089133760337290368624963,   12.045910266667547716679109726101,   12.921145499384522281616227701306,   14.011090978152907382536795921624,   14.986715003301412707514828070998,    0.495862832566711375648083048873,    0.723294885054329483864421490580,    1.901370523072797524832822091412,    3.342220838236194424553104909137,    3.487916814598262860158683906775,    5.412001964376624840724616660737,    5.763705161342366878329812607262,    6.916297785129327024833401083015,    8.281297579476980530444052419625,    8.569182618496725467593932989985,   10.341768796216124215447962342296,   10.797774284832902580433255934622,   11.928446837551426540358079364523,   13.230615098918480754264237475581,   13.637038585972508286658921861090,   15.282950257012114292365367873572,    0.381276657251486739141910220496,    0.626578524906067024780043084320,    2.159074630727548793629466672428,    3.029714238684383609268024883932,    3.736197490294737910687672410859,    5.315039776353881251225175219588,    5.684090393290350817778744385578,    7.130888592228195932420931058004,    8.020215322544489211509244341869,    8.777265536144865265555381483864,   10.259734532072267043645297235344,   10.732253270693425051263147906866,   12.107131475580295898453186964616,   13.012499397708623405378602910787,   13.811426887599896673464172636159,   15.213557719316295191447352408431,    0.327368114839160284645913634449,    0.775360238810416824151161563350,    1.976858044889715948499997466570,    3.175859841385328508067686925642,    3.677508492754116176115530834068;

        // [b,a] = iircomb(250/50, (50/125)/35)
        mco_data <<
        0.000000000000000000000000000000,    0.957020174408697354984099092690,    1.914040348817394709968198185379,    2.871060523226092175974599740584,    3.828080697634789419936396370758,    4.785100872043487107987402850995,    5.659855926085296751182340813102,    6.534610980127106394377278775210,    7.409366034168915149393797037192,    8.284121088210726568945574399550,    9.158876142252534435783672961406,    9.958437556978690707865098374896,   10.757998971704845203589684388135,   11.557560386430999699314270401374,   12.357121801157154195038856414612,   13.156683215883306914406603027601,   -1.424808180238624544244885328226,   -0.693976785821401764842164539004,    0.036854608595822790917395650467,    0.767686003013047457699258302455,    1.498517397430268349722837228910,    3.482768705980297418989266589051,    4.150778088660118214647809509188,    4.818787471339941674841611529700,    5.486796854019764246856993850088,    6.154806236699585042515536770225,    7.968491994908024622645825729705,    8.579079524065980066893644107040,    9.189667053223939063855141284876,    9.800254582381896284459799062461,   10.410842111539851728707617439795,   12.068624074617833485945084248669,   -2.685597077786234798679743107641,   -2.127495439651141850845306180418,   -1.569393801516051345501523428538,   -1.011292163380962616514580076910,    0.503987440414020770873548826785,    2.330356782280781136051928115194,    2.840484198277340777138988414663,    3.350611614273898197779999463819,    3.860739030270453842064171112725,    5.245765727879105000397430558223,    6.915140998188393339773938350845,    7.381418039447205536873752862448,    7.847695080706015069438308273675,    8.313972121964823713824443984777,    9.579942407768438528137266985141,   11.105818762149072043143860355485,   -3.780307998952338266462902538478,   -3.354111969514592672680919349659,
        0.957020174408697354984099092690,    1.914040348817394709968198185379,    2.871060523226092175974599740584,    3.828080697634789419936396370758,    4.785100872043487107987402850995,    5.659855926085296751182340813102,    6.534610980127106394377278775210,    7.409366034168915149393797037192,    8.284121088210726568945574399550,    9.158876142252534435783672961406,    9.958437556978690707865098374896,   10.757998971704845203589684388135,   11.557560386430999699314270401374,   12.357121801157154195038856414612,   13.156683215883306914406603027601,   -1.424808180238624544244885328226,   -0.693976785821401764842164539004,    0.036854608595822790917395650467,    0.767686003013047457699258302455,    1.498517397430268349722837228910,    3.482768705980297418989266589051,    4.150778088660118214647809509188,    4.818787471339941674841611529700,    5.486796854019764246856993850088,    6.154806236699585042515536770225,    7.968491994908024622645825729705,    8.579079524065980066893644107040,    9.189667053223939063855141284876,    9.800254582381896284459799062461,   10.410842111539851728707617439795,   12.068624074617833485945084248669,   -2.685597077786234798679743107641,   -2.127495439651141850845306180418,   -1.569393801516051345501523428538,   -1.011292163380962616514580076910,    0.503987440414020770873548826785,    2.330356782280781136051928115194,    2.840484198277340777138988414663,    3.350611614273898197779999463819,    3.860739030270453842064171112725,    5.245765727879105000397430558223,    6.915140998188393339773938350845,    7.381418039447205536873752862448,    7.847695080706015069438308273675,    8.313972121964823713824443984777,    9.579942407768438528137266985141,   11.105818762149072043143860355485,   -3.780307998952338266462902538478,   -3.354111969514592672680919349659,   -2.927915940076848855255775561091,
        1.914040348817394709968198185379,    2.871060523226092175974599740584,    3.828080697634789419936396370758,    4.785100872043487107987402850995,    5.742121046452184351949199481169,    6.534610980127106394377278775210,    7.409366034168915149393797037192,    8.284121088210726568945574399550,    9.158876142252534435783672961406,   10.033631196294344078978610923514,   10.757998971704845203589684388135,   11.557560386430999699314270401374,   12.357121801157154195038856414612,   13.156683215883306914406603027601,   -1.356078159929696269614396442194,   -0.693976785821401764842164539004,    0.036854608595822790917395650467,    0.767686003013047457699258302455,    1.498517397430268349722837228910,    3.545590717717696627175882895244,    4.150778088660118214647809509188,    4.818787471339941674841611529700,    5.486796854019764246856993850088,    6.154806236699585042515536770225,    8.025913848429887309521291172132,    8.579079524065980066893644107040,    9.189667053223939063855141284876,    9.800254582381896284459799062461,   10.410842111539851728707617439795,   12.121109965640698646893724799156,   -2.685597077786234798679743107641,   -2.127495439651141850845306180418,   -1.569393801516051345501523428538,   -1.011292163380962616514580076910,    0.551961662552552301264086054289,    2.330356782280781136051928115194,    2.840484198277340777138988414663,    3.350611614273898197779999463819,    3.860739030270453842064171112725,    5.289616102616851556206256645964,    6.915140998188393339773938350845,    7.381418039447205536873752862448,    7.847695080706015069438308273675,    8.313972121964823713824443984777,    9.620023419589500690562999807298,   11.105818762149072043143860355485,   -3.780307998952338266462902538478,   -3.354111969514592672680919349659,   -2.927915940076848855255775561091,   -1.734132356422577014853914079140,
        2.871060523226092175974599740584,    3.828080697634789419936396370758,    4.785100872043487107987402850995,    5.742121046452184351949199481169,    6.699141220860881595910996111343,    7.409366034168915149393797037192,    8.284121088210726568945574399550,    9.158876142252534435783672961406,   10.033631196294344078978610923514,   10.908386250336153722173548885621,   11.557560386430999699314270401374,   12.357121801157154195038856414612,   13.156683215883306914406603027601,   -1.356078159929696269614396442194,   -0.556516745203541662867507966439,    0.036854608595822790917395650467,    0.767686003013047457699258302455,    1.498517397430268349722837228910,    3.545590717717696627175882895244,    4.276422112134920183734720922075,    4.818787471339941674841611529700,    5.486796854019764246856993850088,    6.154806236699585042515536770225,    8.025913848429887309521291172132,    8.693923231109708993358253792394,    9.189667053223939063855141284876,    9.800254582381896284459799062461,   10.410842111539851728707617439795,   12.121109965640698646893724799156,   -2.580625295740501812247202906292,   -2.127495439651141850845306180418,   -1.569393801516051345501523428538,   -1.011292163380962616514580076910,    0.551961662552552301264086054289,    2.426305226557846417279051820515,    2.840484198277340777138988414663,    3.350611614273898197779999463819,    3.860739030270453842064171112725,    5.289616102616851556206256645964,    7.002841747663889115926849626703,    7.381418039447205536873752862448,    7.847695080706015069438308273675,    8.313972121964823713824443984777,    9.620023419589500690562999807298,   11.185980785791201697065844200552,   -3.780307998952338266462902538478,   -3.354111969514592672680919349659,   -2.927915940076848855255775561091,   -1.734132356422577014853914079140,   -0.302784139186406786592442585970;
    }
};

TEMPLATE_TEST_CASE_SIG("IIR Filter of arrays", "[iir]",
    ((typename Scalar, int NChan, bool DynOrder, implementation_type Type), Scalar, NChan, DynOrder, Type), 
    (float,  Dynamic, true,  DF1), (float,  Dynamic, true,  DF2), (float,  Dynamic, true,  DF2T),
    (double, Dynamic, true,  DF1), (double, Dynamic, true,  DF2), (double, Dynamic, true,  DF2T),
    (float,  nchan,   true,  DF1), (float,  nchan,   true,  DF2), (float,  nchan,   true,  DF2T),
    (double, nchan,   true,  DF1), (double, nchan,   true,  DF2), (double, nchan,   true,  DF2T),
    (float,  Dynamic, false, DF1), (float,  Dynamic, false, DF2), (float,  Dynamic, false, DF2T),
    (double, Dynamic, false, DF1), (double, Dynamic, false, DF2), (double, Dynamic, false, DF2T),
    (float,  nchan,   false, DF1), (float,  nchan,   false, DF2), (float,  nchan,   false, DF2T),
    (double, nchan,   false, DF1), (double, nchan,   false, DF2), (double, nchan,   false, DF2T)
) {
    const TestFixtureIIR<Scalar> fix;
    Array<Scalar, Dynamic, Dynamic> y(nchan, ndata);
    using Filter = iir<Array<Scalar, NChan, 1>, DynOrder ? Dynamic : 2, Type>;

    const size_t             ndesign = DynOrder ? ndyn_design : nstat_design;
    const iir_design* const* designs = DynOrder ? fix.dyn_designs : fix.stat_designs;
    const auto* const*       refdata = DynOrder ? fix.dyn_data : fix.stat_data;

    SECTION("in_place", "IIR filter applied in place") {
        for (size_t i=0; i<ndesign; ++i) {
            Filter f(*(designs[i]));
            y = fix.raw_data;
            f.apply(y.block(0,  0, nchan,       10));
            f.apply(y.block(0, 10, nchan, ndata-10));
            Scalar maxdev = (*(refdata[i]) - y).abs().maxCoeff();
            REQUIRE( maxdev <= threshold<Scalar>() );
        }
    }

    SECTION("to_other", "IIR filter applied into another array") {
        for (size_t i=0; i<ndesign; ++i) {
            Filter f(*(designs[i]));
            f.apply(fix.raw_data.block(0,  0, nchan,       10), y.block(0,  0, nchan,       10));
            f.apply(fix.raw_data.block(0, 10, nchan, ndata-10), y.block(0, 10, nchan, ndata-10));
            Scalar maxdev = (*(refdata[i]) - y).abs().maxCoeff();
            REQUIRE( maxdev <= threshold<Scalar>() );
        }        
    }

    SECTION("update_only", "IIR filter state updated without applying it") {
        for (size_t i=0; i<ndesign; ++i) {
            Filter f(*(designs[i]));
            y = fix.raw_data;
            f.apply(y.block(0,  0, nchan,       10), dry_run);
            f.apply(y.block(0, 10, nchan, ndata-10));
            Scalar maxdev0 = ((fix.raw_data).block(0,  0, nchan,       10) - y.block(0,  0, nchan,       10)).abs().maxCoeff();
            Scalar maxdev1 = (( refdata[i])->block(0, 10, nchan, ndata-10) - y.block(0, 10, nchan, ndata-10)).abs().maxCoeff();
            REQUIRE( maxdev0 == 0 );
            REQUIRE( maxdev1 <= threshold<Scalar>() );
        }    
    }

    SECTION("init_zero", "IIR filter state initialized with zeroes") {
        for (size_t i=0; i<ndesign; ++i) {
            Filter f(*(designs[i]));
            f.apply(fix.raw_data, y);
            f.initialize();
            f.apply(fix.raw_data, y);
            Scalar maxdev = (*(refdata[i]) - y).abs().maxCoeff();
            REQUIRE( maxdev <= threshold<Scalar>() );
        }
    }

    SECTION("init_nonzero", "IIR filter state initialized with non-zeroes") {
        // Add a DC offset to all channels
        Array<Scalar, 4, 1> x0; x0 << 0, 50, 100, -100;
        Array<Scalar, Dynamic, Dynamic> x = fix.raw_data.colwise() + x0;

        // For a lowpass filter, we expect the output to contain the offset x0
        iir<Array<Scalar, NChan, 1>, DynOrder ? Dynamic : 2, Type> flp(fix.dlp); flp.initialize(x0);
        flp.apply(x, y);
        Scalar maxdev_lp = (fix.mlp_data.colwise() + x0 - y).abs().maxCoeff();
        REQUIRE( maxdev_lp <= threshold<Scalar>() );

        // For a bandpass filter, we expect that the offset is removed
        iir<Array<Scalar, NChan, 1>, DynOrder ? Dynamic : 3, Type> fbp(fix.dbp); fbp.initialize(x0);
        fbp.apply(x, y);
        Scalar maxdev_bp = (fix.mbp_data - y).abs().maxCoeff();
        REQUIRE( maxdev_bp <= threshold<Scalar>() );
    }

}

TEMPLATE_TEST_CASE_SIG("IIR Filter of scalars", "[iir]",
    ((typename Scalar, bool DynOrder, implementation_type Type), Scalar, DynOrder, Type), 
    (float,  true,  DF1), (float,  true,  DF2), (float,  true,  DF2T),
    (double, true,  DF1), (double, true,  DF2), (double, true,  DF2T),
    (float,  false, DF1), (float,  false, DF2), (float,  false, DF2T),
    (double, false, DF1), (double, false, DF2), (double, false, DF2T)
) {
    const TestFixtureIIR<Scalar> fix;
    Array<Scalar, 1, Dynamic> y(ndata);
    using Filter = iir<Scalar, Dynamic, Type>;

    const size_t             ndesign = DynOrder ? ndyn_design : nstat_design;
    const iir_design* const* designs = DynOrder ? fix.dyn_designs : fix.stat_designs;
    const auto* const*       refdata = DynOrder ? fix.dyn_data : fix.stat_data;

    for (size_t i=0; i<ndesign; ++i) {
        Filter f(*(designs[i]));
        for (size_t j=0; j<ndata; ++j)
            y[j] = f(fix.raw_data(0,j));
        Scalar maxdev = (refdata[i]->row(0) - y).abs().maxCoeff();
        REQUIRE( maxdev <= threshold<Scalar>() );
    }
}

TEST_CASE("IIR filter response", "[iir]")
{
    // in matlab:
    // [b,a] = butter(3 [.1, .4], 'bandpass');
    // [h,f] = freqz(b,a,linspace(0,pi,10)); fprintf('%35.30f, ', abs(h)); fprintf('\n'); fprintf('%35.30f, ', angle(h)); fprintf('\n');
    ArrayXd resp_real(10), resp_imag(10);
    resp_real << 0.0,   -0.301014832400589682492864085361,    0.985837693694599837002101594408,    0.105406698500557644004871349352,   -0.450518631772160838000473859211,   -0.122967748079539376804270034427,   -0.025462153010374528883108524724,   -0.003803085414789983929872985158,   -0.000203332660011809661457921061,    0.0;
    resp_imag << 0.0,    0.807314371339338587851841566589,   -0.167701182610685006757478276995,   -0.953437293401544816440207341657,   -0.128390059799641548243798183648,    0.063234523098741196589500646041,    0.030406008571820575259181396177,    0.008442758976603353601730894695,    0.000995779213869737262962433810,    0.0;

    second_order_sections<double> sos = iir_design(butterworth(3), bandpass(.1, .4));
    ArrayXd f = ArrayXd::LinSpaced(Sequential, 10, 0, 1);
    ArrayXcd z(10);
    sos.response(f, z);
    REQUIRE( (resp_real - z.real()).abs().maxCoeff() <= 1e-10 );
    REQUIRE( (resp_imag - z.imag()).abs().maxCoeff() <= 1e-10 );
}